---
layout: post
title: 深入理解字符编码
description: ""
categories: [计算机基础]
tags: 
---

* Kramdown table of contents
{:toc .toc}


# 一、前言
字符编码这个问题，困扰了无数程序员，一不小心就会掉进坑里，每当在开发中遇到乱码或者emoji表情符的奇怪问题时总是让人头疼不已，本文就来从根源上研究一下字符编码的本质和原理。

# 二、什么是编码
编码，就是信息从一种形式转换为另一种形式的过程（其逆过程称为解码）。

那么为什么要编码呢？

![编码示意图]({{ site.baseurl }}/assets/images/posts/encoding1.png)

如上图中例子：
1. 两个说普通话的中国人进行交流时，是不需要编码的，一个人说「你好」，另一个就能直接听明白意思，反之亦然。
2. 一个中国人和美国人交流时，就需要中文和英文互相编码的过程（我们称之为翻译），才能实现交流。
3. 一个人类和计算机交流时，也是一样的道理，大家都知道计算机只认识二进制0和1，因此必须把人类语言转为二进制，才能把信息传递给计算机，这个过程就是编码。

# 三、怎么编码
## 1. ASCII
一种直观的想法就是，制作一个映射表，把人类语言和计算机二进制对应起来就行了，这样的思想就孕育出了ASCII编码（因为是美国人设计的，所以只有常用英文字符），如下表所示：
![USASCII_code_chart]({{ site.baseurl }}/assets/images/posts/ascii.png)

当我们想要编码一个字符时，只要查上表查到对应的数字；解码时同理，根据数字查到对应的字符。非常的简单直接。

但是ASCII也存在问题：
1. 如何表示非标准英语字符（如：Café 里的 é ）？  
一个字节最多能存储 256 种数字，而 ASCII只用到 0-127，因此可以使用 128-255 的区间进行自定义。  
但是不同语言设计了不同的定制规则，导致128-255区间十分混乱，跨语言编解码困难。
2. 更大的问题：东亚语言中的字符种类成千上万种，一个字节装不下了！

## 2. Unicode
于是人们设计了Unicode，目标很宏大：编码这个星球上所有的书写系统中的字符。其实本质思想其实和 ASCII 并无二致，它只是一张更大的映射表。

### 2.1 Code Point 和 Plane 
Unicode 为每个字符分配了一个全局唯一识别码，称为：Code Point。（而且向前兼容 ASCII，原先在 ASCII 中定义的字符映射，在 Unicode 中也是一模一样的。）

Code Point的取值区间：U+0000~U+10FFFF （Code Point 以 U+ 前缀），总共可编码 1114112 个字符。现行最新版本 Unicode 12.1，一共包含了 137,994 个字符，还在不断扩充中。

Code Point 一共划分为17个区域，称为 平面（Plane），每个平面可以容纳 2^16 = 65536 个字符（??0000- ??FFFF）。
Plane0 被称为BMP（Basic Multilingual Plane），涵盖了现在世界上的绝大多数语言。

![Unicode Planes]({{ site.baseurl }}/assets/images/posts/planes.png)
* 蓝色：已分配的 Code Point；
* 绿色：私域，未定义；
* 红色：UTF-16 Surrogate 区域，下文会讲到；
* 白色：未分配；

可以看出现在用的比较多的集中在前三个平面上，它们的使用情况如下所示：
![Unicode Plane 0-2]({{ site.baseurl }}/assets/images/posts/plane0-2.png)
* 蓝色部分的是汉字，可以看出有的在BMP，有的在Plane2
![Unicode Plane 0-2 热度]({{ site.baseurl }}/assets/images/posts/plane0-2_hotness.png)
* Plane1下面那一小块活跃区是emoji

### 2.2 Code Point 存储方案
Code Point 只是一个概念定义，并没有规定实际如何存储，所以在具体实现方案上，出现了不同的方式：
1. 早期简单方案（UCS-2）：早期 Unicode 字符集并不大，可以使用固定的2个字节直接存储 Code Point 值，但很快就不够用了。
2. 直接使用四字节存储（UTF-32）：可以实现，但是每个常用字符前边带一大串000000……存储效率太低，没人愿意用。
3. 变长编码（UTF-16 和 UTF-8）：根据不同情况，灵活使用不同长度的字节存储 Code Point。

## 3. UTF-16
Java 采取的编码方式，以16位作为一个最小编码单元（Code Unit）。

![UTF-16编码规则]({{ site.baseurl }}/assets/images/posts/utf-16.png)

Code Point 编码规则：
* 小于16位的（即BMP），直接用一个编码单元表示。
* 大于16位的，使用一对编码单元共同表示，称为代理（Surrogates，前面的叫 High Surrogate，后面的叫 Low Surrogate）。


## 4. UTF-8
当今互联网最通用的编码方式，以8位为一个编码单元，即一个字节

![UTF-8编码规则]({{ site.baseurl }}/assets/images/posts/utf-8.png)

Code Point 规则:
* 对于单字节的符号，字节的第一位设为0，后面7位为这个符号的 Unicode 码。因此对于英语字母，UTF-8 编码和 ASCII 码是相同的。
* 对于n字节的符号（1 < n <= 4），第一个字节的前n位都设为1，第n + 1位设为0，后面字节的前两位一律设为10。剩下的没有提及的二进制位，全部为这个符号的 Unicode 码。


# 四、编码实战
## 1. 乱码
TODO

## 2.MySQL 中的 UTF-8
UTF-8 是能支持所有的 Unicode 字符的，因此按理说 emoji 不应该会导致问题，但是在MySQL里实现的 utf8 最长只使用3个字节，如果向一个编码为 utf8 的列中插入一个表情符时，就会报类似`Incorrect string value: '\xF0\x9F\xA6\x96  ...' for column 'name'`
这样的错，可以看出此时想要插入的值已经有四个字节了，因此需要指定该列编码格式为 utf8mb4 才行。

## 3. Java字符处理
TODO

# 五、参考资料
[http://cenalulu.github.io/linux/character-encoding/](http://cenalulu.github.io/linux/character-encoding/)  
[https://en.wikipedia.org/wiki/ASCII](https://en.wikipedia.org/wiki/ASCII)  
[https://en.wikipedia.org/wiki/Unicode](https://en.wikipedia.org/wiki/Unicode)  
[https://en.wikipedia.org/wiki/UTF-8](https://en.wikipedia.org/wiki/UTF-8)  
